<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.24.xsd">

    <!-- Create CVE catalog table (language-specific CVE summaries) -->
    <changeSet id="004-create-cve-catalog-table" author="liquibase">
        <createTable tableName="cve_catalog">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cve_id" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="language" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="summary" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="code_example" type="TEXT"/>
            <column name="vulnerable_pattern" type="TEXT"/>
            <column name="fixed_pattern" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP"/>
        </createTable>
        
        <createIndex indexName="idx_cve_catalog_cve_language" tableName="cve_catalog">
            <column name="cve_id"/>
            <column name="language"/>
        </createIndex>
        
        <createIndex indexName="idx_cve_catalog_language" tableName="cve_catalog">
            <column name="language"/>
        </createIndex>
    </changeSet>

    <!-- Create codebase index table -->
    <changeSet id="005-create-codebase-index-table" author="liquibase">
        <createTable tableName="codebase_index">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="repository_url" type="VARCHAR(500)">
                <constraints nullable="false"/>
            </column>
            <column name="language" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="index_data" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="index_version" type="INTEGER" defaultValue="1">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP"/>
        </createTable>
        
        <createIndex indexName="idx_codebase_index_repo" tableName="codebase_index">
            <column name="repository_url"/>
        </createIndex>
        
        <createIndex indexName="idx_codebase_index_repo_lang" tableName="codebase_index">
            <column name="repository_url"/>
            <column name="language"/>
        </createIndex>
    </changeSet>

    <!-- Create bug findings table -->
    <changeSet id="006-create-bug-findings-table" author="liquibase">
        <createTable tableName="bug_findings">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="repository_url" type="VARCHAR(500)">
                <constraints nullable="false"/>
            </column>
            <column name="commit_id" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="cve_id" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="presence_confidence" type="DOUBLE PRECISION"/>
            <column name="fix_confidence" type="DOUBLE PRECISION"/>
            <column name="commit_diff" type="TEXT"/>
            <column name="affected_files" type="TEXT"/>
            <column name="recommended_fix" type="TEXT"/>
            <column name="verification_notes" type="TEXT"/>
            <column name="requires_human_review" type="BOOLEAN" defaultValue="false">
                <constraints nullable="false"/>
            </column>
            <column name="human_reviewed" type="BOOLEAN" defaultValue="false">
                <constraints nullable="false"/>
            </column>
            <column name="human_review_notes" type="TEXT"/>
            <column name="pull_request_id" type="VARCHAR(255)"/>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP"/>
        </createTable>
        
        <createIndex indexName="idx_bug_findings_repo_commit" tableName="bug_findings">
            <column name="repository_url"/>
            <column name="commit_id"/>
        </createIndex>
        
        <createIndex indexName="idx_bug_findings_cve" tableName="bug_findings">
            <column name="cve_id"/>
        </createIndex>
        
        <createIndex indexName="idx_bug_findings_status" tableName="bug_findings">
            <column name="status"/>
        </createIndex>
        
        <createIndex indexName="idx_bug_findings_human_review" tableName="bug_findings">
            <column name="requires_human_review"/>
            <column name="human_reviewed"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>

