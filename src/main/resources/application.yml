spring:
  application:
    name: bug-bounty-finder
  
  # Database Configuration
  datasource:
    url: jdbc:postgresql://localhost:5432/bugbounty
    username: ${DB_USERNAME:postgres}
    password: ${DB_PASSWORD:postgres}
    driver-class-name: org.postgresql.Driver
  
  # JPA Configuration
  jpa:
    hibernate:
      ddl-auto: validate  # Changed from 'update' to 'validate' - schema managed by Liquibase
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true
  
  # Liquibase Configuration
  liquibase:
    change-log: classpath:db/changelog/db.changelog-master.xml
    enabled: true
    drop-first: false
  
  # Redis Configuration
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      timeout: 2000ms
  
  # Virtual Threads (Project Loom)
  threads:
    virtual:
      enabled: true
  
  # Spring AI - Ollama Configuration
  # Using DeepSeek Coder 6.7B - optimized for code review and bug fixing
  # Pull model with: ollama pull deepseek-coder:6.7b
  ai:
    ollama:
      base-url: ${OLLAMA_BASE_URL:http://localhost:11434}
      chat:
        options:
          model: ${OLLAMA_MODEL:deepseek-coder:6.7b}
          temperature: 0.3  # Lower temperature for more deterministic code analysis

# Actuator
# Enhanced configuration for MCP server integration
# See docs/setup/MCP_SERVERS_SETUP.md for MCP server setup
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,loggers,logfile,env
  endpoint:
    health:
      show-details: always
    loggers:
      enabled: true
    logfile:
      enabled: true
      # Log file path for logfile endpoint
      external-file: ./logs/application.log

# Application Configuration
app:
  bounty:
    polling:
      interval-seconds: 300  # 5 minutes
      batch-size: 50
      enabled: true
    platforms:
      algora:
        api-url: https://api.algora.io/v1
        api-key: ${ALGORA_API_KEY:}  # Required: Get by logging into algora.io and generating API key
        rate-limit-per-minute: 60
      polar:
        api-url: https://api.polar.sh
        api-key: ${POLAR_API_KEY:}  # Required: Get by logging into polar.sh and generating API key
        rate-limit-per-minute: 60
      gitpay:
        api-url: https://api.gitpay.me  # Adjust if GitPay uses different API URL
        api-key: ${GITPAY_API_KEY:}  # Required: Get by logging into gitpay.me and generating API key
        rate-limit-per-minute: 60
      github:
        api-url: https://api.github.com
        api-token: ${GITHUB_API_TOKEN:}  # Optional: GitHub Personal Access Token for higher rate limits
        rate-limit-per-hour: 5000
        # Note: Bounties are discovered via Algora/Polar.sh, not by scanning GitHub issues
        # GitHub API is used to fetch issue details after bounties are discovered
  repository:
    clone:
      base-path: ${REPO_CLONE_PATH:./repos}
      max-concurrent-clones: 10
      timeout-seconds: 300
  bounty:
    triage:
      # Languages you have experience with and can human-verify
      # Only bounties in these languages will be processed
      # Format: comma-separated list (e.g., "Java,TypeScript,JavaScript,Python")
      supported-languages: ${TRIAGE_SUPPORTED_LANGUAGES:Java,TypeScript,JavaScript,Python}
      # Maximum complexity level to accept: simple, moderate, or complex
      # REALITY CHECK: Most Algora bounties are complex. Use "simple" to reject 95%+
      max-complexity: ${TRIAGE_MAX_COMPLEXITY:simple}
      # Maximum time estimate (minutes) - reject if LLM estimates longer
      # REALITY CHECK: Even "simple" fixes take 30-60 min with human refinement
      max-time-minutes: ${TRIAGE_MAX_TIME_MINUTES:30}
      # Minimum confidence (0.0-1.0) - reject if LLM confidence is lower
      # REALITY CHECK: Increased to 0.9 to be brutally selective (most bounties are complex)
      min-confidence: ${TRIAGE_MIN_CONFIDENCE:0.9}
      # Maximum bounty amount - higher amounts usually indicate complexity
      # REALITY CHECK: Simple fixes are usually $50-200, higher = more complex
      max-bounty-amount: ${TRIAGE_MAX_BOUNTY_AMOUNT:200}
  llm:
    triage:
      timeout-seconds: 30
      max-retries: 3
  webhooks:
    github:
      enabled: true
      secret: ${GITHUB_WEBHOOK_SECRET:}
      verify-signature: true
  cve:
    monitoring:
      enabled: true
      poll-interval-ms: 3600000  # 1 hour
      min-severity: HIGH  # CRITICAL, HIGH, MEDIUM, LOW
    nvd:
      api-base-url: https://services.nvd.nist.gov/rest/json
      api-key: ${NVD_API_KEY:}  # Optional: Get free API key from https://nvd.nist.gov/developers/request-an-api-key
      rate-limit-delay-ms: 6000  # NVD allows 5 requests per 30 seconds (6 seconds between requests)

# Resilience4j Configuration
resilience4j:
  circuitbreaker:
    instances:
      algoraApi:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 10s
        failureRateThreshold: 50
      polarApi:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 10s
        failureRateThreshold: 50
      gitpayApi:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 10s
        failureRateThreshold: 50
      githubApi:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 10s
        failureRateThreshold: 50
  ratelimiter:
    instances:
      algoraApi:
        limitForPeriod: 60
        limitRefreshPeriod: 60s
        timeoutDuration: 5s
      polarApi:
        limitForPeriod: 60
        limitRefreshPeriod: 60s
        timeoutDuration: 5s
      gitpayApi:
        limitForPeriod: 60
        limitRefreshPeriod: 60s
        timeoutDuration: 5s
      githubApi:
        limitForPeriod: 80  # GitHub allows 5000 requests/hour, so ~83 requests/minute
        limitRefreshPeriod: 60s
        timeoutDuration: 5s

# Logging
# Configured for MCP server integration - logs written to file for Actuator logfile endpoint
logging:
  level:
    root: INFO
    com.bugbounty: DEBUG
    org.springframework.ai: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: ./logs/application.log
    max-size: 10MB
    max-history: 30
